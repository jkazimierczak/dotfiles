mitogen-status() {
  local ANSIBLE_CFG="$HOME/ansible.cfg"

  if [ ! -f "$ANSIBLE_CFG" ]; then
    echo "Ansible configuration file not found: $ANSIBLE_CFG"
    return 1
  fi

  if grep -q '^strategy =' "$ANSIBLE_CFG"; then
    echo "ansible-mitogen is enabled."
    return 1
  else
    echo "ansible-mitogen is disabled."
    return 0
  fi
}

mitogen-on() {
  local ANSIBLE_CFG="$HOME/ansible.cfg"
  local STATE_FILE="$XDG_CONFIG_HOME/ansible-mitogen/state.sh"

  if [ -f "$ANSIBLE_CFG" ]; then
    sed -i 's/# strategy =/strategy =/g' "$ANSIBLE_CFG"
  fi

  echo "export ANSIBLE_MITOGEN=1" > "$STATE_FILE"
  export ANSIBLE_MITOGEN=1

  echo "ansible-mitogen toggled: on"
}

mitogen-off() {
  local ANSIBLE_CFG="$HOME/ansible.cfg"
  local STATE_FILE="$XDG_CONFIG_HOME/ansible-mitogen/state.sh"

  if [ -f "$ANSIBLE_CFG" ]; then
    sed -i 's/strategy =/# strategy =/' "$ANSIBLE_CFG"
  fi

  echo "export ANSIBLE_MITOGEN=0" > "$STATE_FILE"
  export ANSIBLE_MITOGEN=0

  echo "ansible-mitogen toggled: off"
}

init() {
  local STATE_FILE="$XDG_CONFIG_HOME/ansible-mitogen/state.sh"

  if [ ! -f "$STATE_FILE" ]; then
    mkdir -p "$(dirname "$STATE_FILE")"
    echo "export ANSIBLE_MITOGEN=0" > "$STATE_FILE"
    echo "${STATE_FILE} not found, initialized to off. Run mitogen-on/mitogen-off to enable/disable mitogen."
    export ANSIBLE_MITOGEN=0
  fi
}

init
